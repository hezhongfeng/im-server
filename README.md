<img width="464" src="https://i.loli.net/2020/07/01/AmsnawZ29RbUqk8.png">

å³æ—¶é€šè®¯åº”ç”¨, åŒ…å«[æœåŠ¡ç«¯](https://github.com/hezhongfeng/im-server)ã€[ç®¡ç†ç«¯](https://github.com/hezhongfeng/im-fe-admin)å’Œ[å®¢æˆ·ç«¯](https://github.com/hezhongfeng/im-fe-client)

## ä»‹ç»

ä½¿ç”¨ egg æ¡†æ¶ï¼ŒIM æœåŠ¡çš„æœåŠ¡ç«¯

## åŠŸèƒ½ç®€ä»‹

1. æ³¨å†Œï¼Œç™»å½•ï¼Œä¸ªäººã€ç¾¤ç»„èŠå¤©ï¼Œä¸ªäººä¿¡æ¯ç¼–è¾‘ç­‰åŸºç¡€åŠŸèƒ½
2. ç”³è¯·æ·»åŠ å¥½å‹å’Œç”³è¯·å…¥ç¾¤
3. è¡¨æƒ…ï¼Œå›¾ç‰‡ï¼Œè§†é¢‘ï¼Œå®šä½ä¿¡æ¯æ”¯æŒ
4. èŠå¤©ä¼šè¯åˆ—è¡¨è®°å½•
5. æ¶ˆæ¯è®°å½•ï¼ˆå¾®ä¿¡çš„æ¶ˆæ¯è®°å½•çœŸå®ä¸€è¨€éš¾å°½ï¼‰
6. æ”¯æŒå¤šç‚¹åŒæ—¶ç™»å½•
7. ç™¾åº¦ UNIT æœºå™¨äººè‡ªåŠ¨å›å¤(todo)
8. ç®¡ç†ç«¯ï¼Œè¿›è¡Œè§’è‰²å’Œæƒé™çš„ç®¡ç†ï¼Œç¾¤çŠ¶æ€ç®¡ç†ï¼ˆæˆ‘ä¹Ÿå½“ä¸€å›é©¬åŒ–è…¾ï¼‰

## éœ€æ±‚ç®€ä»‹

ç§»åŠ¨äº’è”ç½‘å‘å±•è‡³ä»Šï¼Œä»¥å¾®ä¿¡ä¸ºé¦–çš„å³æ—¶é€šè®¯æœåŠ¡å·²ç»èå…¥äº†æˆ‘ä»¬ç”Ÿæ´»ä¸­çš„å„ä¸ªè§’è½ï¼Œåœ¨å…¬å¸çš„ä¸€äº›ä¸šåŠ¡ä¸­ä¹Ÿæ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œå¯¹äºå³æ—¶é€šè®¯æˆ‘ä»¬å…¬å¸åŸæ¥æ˜¯ä½¿ç”¨çš„ç¯ä¿¡çš„æœåŠ¡ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå®šåˆ¶åŒ–çš„éœ€æ±‚æ— æ³•å®ç°ï¼Œæ‰€ä»¥åæ¥å†³å®šå†…éƒ¨å¼€å‘ä¸€ä¸ªæ»¡è¶³å®šåˆ¶åŒ–éœ€æ±‚çš„å³æ—¶é€šè®¯å¾®æœåŠ¡ã€‚

ä½¿ç”¨`socket.io`æ¡†æ¶æ˜¯å› ä¸ºå½“æ—¶åç«¯ç¼ºäººï¼ŒåŠ ä¸Šçœ‹äº†ä¸€äº›ä¾‹å­åè§‰å¾—ä½¿ç”¨èµ·æ¥çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”å…¨å¹³å°æ”¯æŒï¼Œæ‰€ä»¥è¿™ä¸ªå¾®æœåŠ¡å°±åœ¨å‰ç«¯å›¢é˜Ÿè¿›è¡Œè½åœ°å®è·µï¼Œç›®å‰æ•ˆæœè¿˜ä¸é”™ã€‚

ç¤¾åŒºç›®å‰è¿™æ–¹é¢çš„å†…å®¹æ¯”è¾ƒå°‘æˆ–è€…å¤ªç®€é™‹ï¼ˆåªæœ‰ä¸€ä¸ªå…¬å…±çš„èŠå¤©å®¤è¿™ç§ï¼‰ã€‚å¦å¤–å°±æ˜¯åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­è¢« PM æå¾—å¾ˆéš¾å—ï¼Œæ‰€ä»¥æƒ³è„±ç¦»ä¸€äº›ç‰¹æœ‰çš„ä¸šåŠ¡ä¸Šçš„ä¸œè¥¿ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½ç®€å•äº”è„ä¿±å…¨çš„ä¸æºæ‚å…¬å¸ä¸šåŠ¡çš„ IM åº”ç”¨,åŒ…å«æœåŠ¡ç«¯ï¼Œç®¡ç†ç«¯å’Œå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯çš„æ¨¡ä»¿å¯¹è±¡æ˜¯å¾®ä¿¡ï¼Œå› ä¸ºæˆ‘å¾ˆç†Ÿæ‚‰ï¼Œä¸ç”¨åœ¨äº§å“ä¸Šé¢æ€è€ƒå¤ªå¤šï¼Œå¦å¤–å°±æ˜¯è¯•ç”¨çš„äººå¾ˆç†Ÿæ‚‰ï¼Œä¸éœ€è¦å¤ªå¤šçš„æ²Ÿé€šæˆæœ¬ã€‚

## æ¡†æ¶ç®€ä»‹

è¦å¼€å‘ä¸€å¥—å®Œæ•´çš„å³æ—¶é€šè®¯æœåŠ¡ï¼Œéœ€è¦ä»¥ä¸‹éƒ¨åˆ†ï¼š

1. æœåŠ¡ç«¯ï¼šç”¨æ¥å®ç°åŸºç¡€çš„æœåŠ¡æ¥å£å’Œæ•°æ®æŒä¹…åŒ–
2. å®¢æˆ·ç«¯ï¼šå®Œæˆç™»å½•ã€èŠå¤©ç­‰åŸºç¡€åŠŸèƒ½ï¼Œç±»ä¼¼å¾®ä¿¡
3. ç®¡ç†ç«¯ï¼šç®¡ç†ç¾¤ç»„ã€ç”¨æˆ·å’Œè§’è‰²æƒé™

### server

> ä¸ºä¼ä¸šçº§æ¡†æ¶å’Œåº”ç”¨è€Œç”Ÿ

é€‰ç”¨é˜¿é‡Œçš„ egg.js æ¡†æ¶åšæ”¯æ’‘ï¼Œçœ‹ä¸­çš„åŸå› æ˜¯ä»–ä»¬å†…éƒ¨å¤§è§„æ¨¡çš„è½åœ°å’Œå®‰å…¨æ–¹é¢åšå¾—æ¯”è¾ƒå¥½ï¼Œæ²¡æœ‰é€‰æ‹© nest çš„åŸå› æ˜¯é›†æˆ `socket.io` æ¯”è¾ƒéº»çƒ¦ï¼ŒORM é€‰ç”¨ sequelizeï¼Œæ•°æ®åº“æ˜¯ mysql ,ä¹‹å‰ä¸€èµ·ä½¿ç”¨è¿‡ï¼Œä¸Šæ‰‹éš¾åº¦å°

### admin

> å¼€ç®±å³ç”¨çš„ä¸­å°å‰ç«¯/è®¾è®¡è§£å†³æ–¹æ¡ˆ

é€‰æ‹© Ant Design Pro ä½œä¸ºæ¨¡æ¿å¼€å‘ç®¡ç†ç«¯ï¼Œé€‰ç”¨çš„åŸå› æ˜¯æˆ‘å¯¹ Vue å…¨å®¶æ¡¶æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæƒ³å€Ÿç€è¿™ä¸ªæœºä¼šç†Ÿæ‚‰ä¸‹æ•´å¥— React ç”Ÿæ€ çš„å¼€å‘æµç¨‹ï¼Œæ„Ÿå—ä¸‹ç›®å‰å›½å†…ä¸¤å¤§å¼€å‘æ¡†æ¶çš„æœ¬è´¨åŒºåˆ«å’Œæ®Šé€”åŒå½’ï¼ŒAnt Design Pro å·²ç»å‘å¸ƒäº†å¥½å‡ å¹´äº†ï¼Œä¹Ÿçš„ç¡®ç»™ä¸­å°å‹ä¼ä¸šå¸¦æ¥æ•ˆç‡çš„æå‡ï¼Œä¹Ÿæ­£å¥½é€‚åˆæˆ‘è¿™çš„éœ€æ±‚ã€‚

### client

> ğŸ› ï¸ Vue.js å¼€å‘çš„æ ‡å‡†å·¥å…·

ä½¿ç”¨ @vue/cli æ­å»º IM æœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œä¸€ä¸ªç§»åŠ¨ç«¯çš„ H5 é¡¹ç›®ï¼ŒUI æ¡†æ¶ä½¿ç”¨çš„æœ‰èµ vantï¼Œé›†æˆäº†æˆ‘çš„å¼€æºç»„ä»¶[vue-page-stack](https://github.com/hezhongfeng/vue-page-stack)å’Œé»„è€å¸ˆçš„[better-scroll](https://github.com/ustbhuangyi/better-scroll)ï¼Œå®ç° IM çš„åŸºç¡€åŠŸèƒ½

## å®ä½“å…³ç³»

ä½œä¸ºä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆï¼Œå¤§å¤šæ•°çš„æ—¥å¸¸å·¥ä½œæ˜¯ä¸éœ€è¦æ€è€ƒå®ä½“å…³ç³»çš„ã€‚ä½†æ˜¯ï¼Œå°±æˆ‘çš„å®é™…ä½“éªŒæ¥çœ‹ï¼Œæ‡‚å¾—å®ä½“å…³ç³»å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£ä¸šåŠ¡æ¨¡å‹ã€‚è€Œå¯¹äº§å“å’Œä¸šåŠ¡ç†è§£çš„æå‡å¯¹æˆ‘ä»¬çš„å¸®åŠ©æ˜¯éå¸¸å¤§çš„ï¼Œå¯ä»¥åœ¨éœ€æ±‚è¯„å®¡çš„æ—¶å€™å‘ç°å¾ˆå¤šä¸ç¬¦åˆé€»è¾‘çš„åœ°æ–¹ï¼ˆæ€ä¹ˆåˆè¦åæ§½äº§å“ç»ç†äº†ï¼‰ï¼Œè¿™æ—¶å€™èƒ½æå‡ºæ¥å°±ä¼šä¸»åŠ¨é¿å…æˆ‘ä»¬åœ¨åç»­çš„è¿‡ç¨‹ä¸­è¿›è¡Œåå¤å¼€å‘ï¼ŒåŒæ—¶å¯ä»¥å’Œäº§å“ä¾§çš„åŒå­¦å½¢æˆæ¯”è¾ƒè‰¯å¥½çš„äº’åŠ¨ï¼ˆè€Œä¸æ˜¯äº’æ€¼ï¼‰ã€‚ä¸‹é¢ç®€å•ç½—åˆ—ä¸‹æ¯”è¾ƒé‡è¦çš„å®ä½“å…³ç³»ï¼š

<img width="600" src="https://i.loli.net/2020/07/14/Zhz85V2ptOylDcj.png">

é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ° user æ˜¯æ•´ä¸ªå…³ç³»å›¾ä¸­çš„æ ¸å¿ƒï¼Œä¸‹é¢ä»‹ç»ä¸‹å„ä¸ªå®ä½“ä¹‹é—´çš„å…³ç³»ï¼š

1. user å’Œ user_info(ç”¨æˆ·ä¿¡æ¯) æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»
2. user å’Œ role(è§’è‰²)æ˜¯å¤šå¯¹å¤šçš„å…³ç³»
3. role å’Œ right(æƒé™)æ˜¯å¤šå¯¹å¤šçš„å…³ç³»
4. user å’Œ apply(ç”³è¯·)æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œç”³è¯·éƒ½æ˜¯æ¶‰åŠåˆ°ä¸¤ä¸ª userï¼ˆç”³è¯·äººå’Œè¢«ç”³è¯·äººï¼‰
5. user å’Œ group(ç¾¤ç»„)æ˜¯å¤šå¯¹å¤šçš„å…³ç³»
6. group å’Œ conversation(ä¼šè¯) æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»
7. friend å’Œ conversation(ä¼šè¯) æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»
8. conversation å’Œ message(æ¶ˆæ¯)æ˜¯ 1 å¯¹å¤šçš„å…³ç³»
9. friend(å¥½å‹å…³ç³») å’Œ user æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œfriend ç”±ä¸¤ä¸ª user ç¡®å®š

ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸‹ä¼šè¯ã€è§’è‰²ä¸æƒé™ï¼š

### ä¼šè¯

å®Œæˆä¸€ä¸ªå³æ—¶é€šè®¯åº”ç”¨ï¼Œéœ€è¦è€ƒè™‘çš„ç¬¬ä¸€ä¸ªäº‹æƒ…å°±æ˜¯ä¼šè¯ï¼Œå°±æ˜¯æˆ‘ä»¬å¾®ä¿¡é‡Œé¢çš„å¯¹è¯çª—å£ã€‚æ€è€ƒä¼šè¯å’Œæ¶ˆæ¯ã€ç”¨æˆ·ã€ç¾¤ç»„ä¹‹é—´çš„å…³ç³»èŠ±è´¹äº†ä¸å°‘çš„ç²¾åŠ›ï¼Œæœ€ç»ˆå½¢æˆä»¥ä¸‹çš„åŸºæœ¬å…³ç³»ï¼š

1. 2 ä¸ªç”¨æˆ·å‚ä¸çš„èŠå¤©å±äºå»ºç«‹äº† Friend å…³ç³»ï¼ˆäº’ä¸ºå¥½å‹ï¼‰
2. å¤šä¸ªç”¨æˆ·å‚ä¸çš„èŠå¤©ç»„æˆäº†ç¾¤ç»„å…³ç³»
3. Friend å’Œä¼šè¯ä¹‹é—´çš„å…³ç³»æ˜¯ 1 å¯¹ 1 çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ Friend æ‰¾åˆ°æ­¤ Friend çš„ä¼šè¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼šè¯ç¡®å®š Friend
4. ç¾¤ç»„å’Œä¼šè¯ä¹‹é—´çš„å…³ç³»æ˜¯ 1 å¯¹ 1 çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ç¾¤ç»„æ‰¾åˆ°æ­¤ç¾¤ç»„çš„ä¼šè¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼šè¯ç¡®å®šç¾¤ç»„
5. æ¶ˆæ¯å±äºæŸä¸ªä¼šè¯ï¼Œå¯ä»¥æ ¹æ®ä¼šè¯æŸ¥çœ‹å¯¹åº”çš„æ¶ˆæ¯åˆ—è¡¨
6. ä¿å­˜æ¶ˆæ¯çš„æ—¶å€™æ›´æ–°ä¼šè¯çš„æ¿€æ´»æ—¶é—´ï¼Œç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨æ ¹æ®æ¿€æ´»æ—¶é—´æ’åºï¼Œä¹Ÿå°±æ˜¯æœ€è¿‘çš„ä¼šè¯å†æœ€å‰é¢

ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·å’Œä¼šè¯æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œåªèƒ½é€šè¿‡ç”¨æˆ·å¯¹åº”çš„å•èŠå’Œç¾¤èŠå»è·å–ä¼šè¯ï¼Œè¿™æ ·åšå¯ä»¥æœ‰ä»¥ä¸‹çš„å¥½å¤„ï¼š

1. æ— è®ºæ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œè¿æ¥ä¸Šçš„ç”¨æˆ·åªè¦ join è¿›å¯¹åº”çš„ä¼šè¯ room é‡Œé¢å°±å¯ä»¥ï¼Œæ¶ˆæ¯ä¹Ÿæ˜¯åœ¨å¯¹åº”çš„ room é‡Œé¢å‘å¸ƒ
2. æ— è®ºæ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œæ¶ˆæ¯çš„ä¿å­˜å’ŒæŸ¥è¯¢éƒ½æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯åªé’ˆå¯¹è¿™ä¸ªä¼šè¯
3. è·å–ä¸ªäººçš„ä¼šè¯åˆ—è¡¨ä¹Ÿå˜å¾—å¾ˆç®€å•ï¼Œç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨é€šè¿‡æŸ¥è¯¢ç”¨æˆ·ã€æ‰€æœ‰çš„ Friend å’Œç¾¤ç»„ã€->ã€æ‰€æœ‰çš„ä¼šè¯ã€->ã€æ’åºä¼šè¯(æ ¹æ®æ¿€æ´»æ—¶é—´)ã€ï¼Œå°±å¯ä»¥è·å–

### è§’è‰²å’Œæƒé™

ä¸ºäº†è®¾è®¡ä¸€ä¸ªçµæ´»ã€é€šç”¨ã€æ–¹ä¾¿çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼Œæœ¬ç³»ç»Ÿé‡‡ç”¨ RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ§åˆ¶ï¼Œæ¥è®¾è®¡ä¸€ä¸ªé€šç”¨çš„ã€ç”¨æˆ·è§’è‰²æƒé™ã€å¹³å°ï¼Œæ–¹ä¾¿åæœŸæ‰©å±•ã€‚

#### RBAC

RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ˜¯æŒ‡ç”¨æˆ·é€šè¿‡è§’è‰²ä¸æƒé™è¿›è¡Œå…³è”ã€‚å³ä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰è‹¥å¹²è§’è‰²ï¼Œæ¯ä¸€ä¸ªè§’è‰²æ‹¥æœ‰è‹¥å¹²æƒé™(å½“ç„¶äº†ï¼Œåˆ«æŠŠå†²çªçš„è§’è‰²å’Œæƒé™é…åœ¨ä¸€èµ·)ã€‚è¿™æ ·ï¼Œå°±æ„é€ æˆâ€œç”¨æˆ·â€”è§’è‰²â€”æƒé™â€çš„æˆæƒæ¨¡å‹ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œç”¨æˆ·ä¸è§’è‰²ä¹‹é—´ã€è§’è‰²ä¸æƒé™ä¹‹é—´ï¼Œä¸€èˆ¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚

#### æœ¬ç³»ç»Ÿé»˜è®¤çš„è§’è‰²å’Œæƒé™

æœ¬ç³»ç»Ÿé»˜è®¤æœ‰ç®¡ç†å‘˜ã€ä¸€èˆ¬ç”¨æˆ·ã€ç¦è¨€ç”¨æˆ·å’Œå°ç¦ç”¨æˆ·è¿™å‡ ç§è§’è‰²ï¼Œç»™ä¸åŒçš„è§’è‰²åˆ†é…ä¸åŒçš„æƒé™ï¼Œæ‰€ä»¥éœ€è¦é’ˆå¯¹ç®¡ç†å’Œå‘è¨€ç­‰æ¥å£è·¯ç”±åšä¸€ä¸‹ç»Ÿä¸€çš„é‰´æƒï¼ˆé€šè¿‡ä¸­é—´ä»¶çš„æ–¹å¼ï¼‰å¤„ç†ï¼Œå…·ä½“æ–¹å¼å’Œæ–¹æ³•åœ¨åç«¯é¡¹ç›®ä¸­ä¼šè¯¦ç»†è¯´æ˜ã€‚æœ¬ç³»ç»Ÿæš‚æ—¶é‡‡ç”¨é¢„å…ˆå®šä¹‰äº†è§’è‰²å’Œæƒé™çš„æ–¹å¼ï¼Œåç»­æƒ³è¦æ‰©å±•çš„è¯å¯ä»¥ç¼–è¾‘è§’è‰²å’Œæƒé™ã€‚

#### ç®¡ç†å‘˜

æ²¡è§è¿‡å¾®ä¿¡çš„ç®¡ç†ç«¯ï¼Œä½†æ˜¯å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œç®¡ç†å‘˜å¯ä»¥é…ç½®ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ï¼Œå¯ä»¥ç¼–è¾‘ç¾¤ç»„çš„çŠ¶æ€ï¼š

1. ç™»å½•çš„æƒé™
2. ç¾¤ç»„çŠ¶æ€çš„ç¼–è¾‘
3. é’ˆå¯¹ç”¨æˆ·çš„è§’è‰²å’Œæƒé™çš„ç¼–è¾‘

#### æ™®é€šç”¨æˆ·

æ³¨å†Œç™»å½•åï¼Œå¯ä»¥æ­£å¸¸çš„æ·»åŠ å¥½å‹å’ŒåŠ å…¥ç¾¤ç»„ï¼Œå¯ä»¥ä¿®æ”¹ä¸ªäººåŸºç¡€ä¿¡æ¯å’Œå¤„ç†ç”³è¯·

1. æ³¨å†Œç™»å½•
2. ç¼–è¾‘ä¸ªäººåŸºç¡€ä¿¡æ¯
3. æ·»åŠ å¥½å‹ï¼Œç”³è¯·å…¥ç¾¤
4. å¤„ç†å¥½å‹ç”³è¯·å’Œå…¥ç¾¤ç”³è¯·
5. èŠå¤©

#### ç¦è¨€ç”¨æˆ·

1. æ³¨å†Œç™»å½•
2. ç¼–è¾‘ä¸ªäººåŸºç¡€ä¿¡æ¯
3. æ·»åŠ å¥½å‹ï¼Œç”³è¯·å…¥ç¾¤
4. å¤„ç†å¥½å‹ç”³è¯·å’Œå…¥ç¾¤ç”³è¯·

#### å°ç¦ç”¨æˆ·

æ— æ³•ç™»å½•

#### è§’è‰²çš„ç»„åˆ

ä¸¾ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰ä¸€ä¸ªæ–°ç‰ˆçš„ä¸ªäººä¸­å¿ƒéœ€è¦ä¸Šçº¿æµ‹è¯•ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªè§’è‰²ã€æµ‹è¯•ä¸ªäººä¸­å¿ƒã€ï¼Œå†ç»™è¿™ä¸ªè§’è‰²åˆ†é…å¯¹åº”çš„æƒé™ï¼›ç„¶åç»™æ™®é€šç”¨æˆ·åšä¸ªåˆ†ç»„ï¼Œé€‰å‡ºä¸€äº›äººé…ç½®ä¸Šè¿™ä¸ªè§’è‰²ï¼Œè¿™æ ·å°±å¯ä»¥è¿›è¡Œæµ‹è¯•äº†ã€‚

## å³æ—¶é€šè®¯åŸç†

ä¸‹é¢è¯´ä¸‹å³æ—¶é€šè®¯æœåŠ¡çš„æ ¸å¿ƒé€šè®¯åŸç†ï¼Œå’Œä¸€èˆ¬çš„ http æœåŠ¡ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šè®¯ï¼Œåªä¸è¿‡è¯¦ç»†çš„åè®®å’Œå¤„ç†æ–¹å¼ä¸ä¸€æ ·ã€‚

### WebSocket

ç”±äºå†å²åŸå› ï¼Œç°åœ¨ä¸»æµçš„ http åè®®æ˜¯æ— çŠ¶æ€åè®®ï¼ˆHTTP2 æš‚æ—¶åº”ç”¨ä¸å¹¿æ³›ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼Œç„¶åæœåŠ¡ç«¯å»å“åº”ã€‚é‚£ä¹ˆä¸ºäº†å®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå°±éœ€è¦å‰ç«¯ä¸»åŠ¨å‘åç«¯å»è½®è¯¢ï¼Œè¿™ç§æ–¹å¼ä½æ•ˆä¸”å®¹æ˜“å‡ºé”™,åœ¨ä¹‹å‰æˆ‘ä»¬çš„ç®¡ç†ç«¯é¦–é¡µç¡®å®æ˜¯è¿™ä¹ˆåšçš„ï¼ˆ5s ä¸€æ¬¡ï¼‰ã€‚

ä¸ºäº†å®ç°è¿™ç§æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ä¿¡æ¯çš„éœ€æ±‚ï¼Œ HTML5 å¼€å§‹æä¾›ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ï¼Œä¹Ÿå°±æ˜¯ WebSocketã€‚WebSocket ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚WebSocket åè®®åœ¨ 2008 å¹´è¯ç”Ÿï¼Œ2011 å¹´æˆä¸ºå›½é™…æ ‡å‡†ï¼Œç›®å‰ç»å¤§éƒ¨åˆ†æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº†ã€‚

![](https://i.loli.net/2020/07/14/hUcq98xWCi3loVb.png)

WebSocket çš„ç”¨æ³•ç›¸å½“ç®€å•:

```
var ws = new WebSocket("wss://echo.websocket.org");

ws.onopen = function(evt) {
  console.log("Connection open ...");
  ws.send("Hello WebSockets!");
};

ws.onmessage = function(evt) {
  console.log( "Received Message: " + evt.data);
  ws.close();
};

ws.onclose = function(evt) {
  console.log("Connection closed.");
};
```

æœ‰äº† WebSocket åè®®è®©æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ä¿¡æ¯æœ‰äº†å…ˆè¿›çš„æ­¦å™¨ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å…¼å®¹æ–°æ—§æµè§ˆå™¨å‘¢ï¼Ÿå…¶å®å¾ˆå¤šäººæƒ³åˆ°äº†è¿™ç‚¹ï¼Œç­”æ¡ˆå°±æ˜¯`socket.io`

### `socket.io`

`socket.io`è¿›ä¸€æ­¥å°è£…äº†`WebSocket`çš„æ¥å£ï¼Œè€Œä¸”å¯ä»¥åœ¨æ—§ç‰ˆæœ¬æµè§ˆå™¨ä¸­è‡ªä¸»åˆ‡æ¢åˆ°ä½¿ç”¨è½®è¯¢çš„æ–¹å¼è¿›è¡Œé€šè®¯ï¼ˆæˆ‘ä»¬ä½¿ç”¨è€…æ˜¯ä¸ä¼šæ„ŸçŸ¥çš„ï¼‰ï¼Œå½¢æˆäº†ä¸€å¥—ç»Ÿä¸€çš„æ¥å£ï¼Œå¤§å¤§å‡è½»äº†å¼€å‘çš„è´Ÿæ‹…ã€‚ä¸»è¦å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

1. å°è£…å‡ºäº†ä¸€å¥—éå¸¸æ˜“ç”¨çš„æ¥å£ï¼Œå‰åç«¯ç»Ÿä¸€ï¼Œä½¿ç”¨éå¸¸ç®€å•
2. å…¨å¹³å°æ”¯æŒï¼ˆåŸç”Ÿå’Œ H5ï¼Œå¾®ä¿¡å°ç¨‹åºä¸­ä¹Ÿæœ‰å¯¹åº”çš„å®ç°ï¼‰
3. è‡ªé€‚åº”æµè§ˆå™¨ï¼Œåœ¨æ¯”è¾ƒè€çš„æµè§ˆå™¨ä¸­ä¸»åŠ¨åˆ‡æ¢ä½¿ç”¨è½®è¯¢çš„æ–¹å¼ï¼Œä¸éœ€è¦æˆ‘ä»¬è‡ªå·±æè½®è¯¢

[è¿™æ˜¯ socket.io ä¸»é¡µ](https://socket.io/)

> æœ€å¿«ï¼Œæœ€å¯é çš„å³æ—¶é€šè®¯å¼•æ“(FEATURING THE FASTEST AND MOST RELIABLE REAL-TIME ENGINE)

ä½¿ç”¨èµ·æ¥çœŸçš„å¾ˆç®€å•ï¼š

```
var io = require('socket.io')(80);
var cfg = require('./config.json');
var tw = require('node-tweet-stream')(cfg);
tw.track('socket.io');
tw.track('javascript');
tw.on('tweet', function(tweet){
  io.emit('tweet', tweet);
});
```

## server ç«¯è¯¦ç»†è¯´æ˜

ä½¿ç”¨è„šæ‰‹æ¶åˆå§‹åŒ– server é¡¹ç›®ï¼Œä¸‹é¢è¯´ä¸‹åç«¯é¡¹ç›®ä¸­æˆ‘è®¤ä¸ºå‡ ä¸ªé‡è¦çš„ç‚¹ï¼Œå¤§éƒ¨åˆ†å†…å®¹éœ€è¦å» egg [å®˜ç½‘](https://eggjs.org/zh-cn/)æŸ¥çœ‹

```
// ç›®å½•ç»“æ„è¯´æ˜

â”œâ”€â”€ package.json // é¡¹ç›®ä¿¡æ¯
â”œâ”€â”€ app.js // å¯åŠ¨æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€äº›é’©å­å‡½æ•°
â”œâ”€â”€ app
|   â”œâ”€â”€ router.js // è·¯ç”±
â”‚   â”œâ”€â”€ controller
â”‚   â”œâ”€â”€ service
â”‚   â”œâ”€â”€ middleware // ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ model // å®ä½“æ¨¡å‹
â”‚   â””â”€â”€ io // socket.io ç›¸å…³
â”‚       â”œâ”€â”€ controller
â”‚       â””â”€â”€ middleware // ioç‹¬æœ‰çš„ä¸­é—´ä»¶
â”œâ”€â”€ config // é…ç½®æ–‡ä»¶
|   â”œâ”€â”€ plugin.js // æ’ä»¶é…ç½®æ–‡ä»¶
|   â””â”€â”€ config.default.js // é»˜è®¤çš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ logs // serverè¿è¡ŒæœŸé—´äº§ç”Ÿçš„logæ–‡ä»¶
â””â”€â”€ public // é™æ€æ–‡ä»¶å’Œä¸Šä¼ æ–‡ä»¶ç›®å½•
```

## è·¯ç”±

Router ä¸»è¦ç”¨æ¥æè¿°è¯·æ±‚ URL å’Œå…·ä½“æ‰¿æ‹…æ‰§è¡ŒåŠ¨ä½œçš„ Controller çš„å¯¹åº”å…³ç³»ï¼Œå³ `app/router`

1. è·¯ç”±ä½¿ç”¨äº†ç‰ˆæœ¬å· v1ï¼Œæ–¹ä¾¿ä»¥åå‡çº§ï¼Œä¸€èˆ¬çš„å¢åˆ æ”¹æŸ¥ç›´æ¥ä½¿ç”¨ restful çš„æ–¹å¼æ¯”è¾ƒç®€å•
2. é™¤äº†ç™»å½•å’Œæ³¨å†Œçš„æ¥å£ï¼Œåœ¨å…¶ä½™æ‰€æœ‰ http æ¥å£æ·»åŠ äº†å¯¹ session çš„æ£€æŸ¥ï¼Œæ ¡éªŒç™»å½•çŠ¶æ€ï¼Œä½ç½®åœ¨`app/middleware/auth.js`
3. åœ¨æ‰€æœ‰ç®¡ç†ç«¯çš„æ¥å£å¤„æ·»åŠ äº†å¯¹ admin æƒé™çš„æ£€æŸ¥ï¼Œä½ç½®åœ¨`app/middleware/admin.js`

## ç»Ÿä¸€é‰´æƒ

å› ä¸ºæœ¬ç³»ç»Ÿé¢„è®¾æœ‰ç®¡ç†å‘˜å’Œä¸€èˆ¬é€šä¿¡ç”¨æˆ·çš„ä¸åŒè§’è‰²ï¼Œæ‰€ä»¥éœ€è¦é’ˆå¯¹ç®¡ç†å’Œé€šä¿¡çš„æ¥å£è·¯ç”±åšä¸€ä¸‹ç»Ÿä¸€çš„é‰´æƒå¤„ç†ã€‚

æ¯”å¦‚ç®¡ç†ç«¯çš„è·¯ç”±`/v1/admin/...`ï¼Œæƒ³åœ¨è¿™ä¸ªç³»åˆ—è·¯ç”±å…¨éƒ½æ·»åŠ ç®¡ç†å‘˜çš„é‰´æƒï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨ä¸­é—´ä»¶çš„æ–¹å¼è¿›è¡Œé‰´æƒï¼Œä¸‹é¢æ˜¯åœ¨ admin router ä¸­ä½¿ç”¨ä¸­é—´ä»¶çš„å…·ä½“ä¾‹å­

```
// middware
module.exports = () => {
  return async function admin(ctx, next) {
    let { session } = ctx;

    // åˆ¤æ–­adminæƒé™
    if (session.user && session.user.rights.some(right => right.keyName === 'admin')) {
      await next();
    } else {
      ctx.redirect('/login');
    }
  };
};

// router
const admin = app.middleware.admin();
router.get('/api/v1/admin/rights', admin, controller.v1.admin.rightsIndex);
```

## model å®ä½“æ¨¡å‹

ä½¿ç”¨çš„ sequelize+mysql ç»„åˆï¼Œæ¨¡å‹çš„åŸºç¡€ä¿¡æ¯æ¯”è¾ƒå®¹æ˜“å¤„ç†ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯å®ä½“ç›´æ¥çš„å…³ç³»è®¾è®¡ï¼Œå³ associateï¼Œä¸‹é¢æ˜¯ user çš„å…³ç³»æè¿°

```
User.associate = function() {
  // One-To-One associations
  app.model.User.hasOne(app.model.UserInfo);

  // One-To-Many associations
  app.model.User.hasMany(app.model.Apply);

  // Many-To-Many associations
  app.model.User.belongsToMany(app.model.Group, { through: 'user_group' });
  app.model.User.belongsToMany(app.model.Role, { through: 'user_role' });
  // app.model.User.belongsToMany(app.model.Conversation, { through: 'user_conversation' });
};
```

### ä¸€å¯¹ä¸€

ä¾‹å¦‚ user å’Œ userInfo çš„å…³ç³»å°±æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œå®šä¹‰å¥½äº†ä¹‹åï¼Œæˆ‘ä»¬åœ¨æ–°å»º user çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ `user.setUserInfo(userInfo)`äº†ï¼Œæƒ³è·å–æ­¤ user çš„åŸºç¡€ä¿¡æ¯çš„æ—¶å€™ä¹Ÿå¯ä»¥é€šè¿‡`user.getUserInfo()`

### ä¸€å¯¹å¤š

User å’Œ Applyï¼ˆç”³è¯·ï¼‰çš„å…³ç³»å°±æ˜¯ä¸€å¯¹å¤šï¼Œå³ä¸€ä¸ªç”¨æˆ·å¯ä»¥å¯¹åº”å¤šä¸ªè‡ªå·±çš„ç”³è¯·ï¼Œç›®å‰åªæœ‰å¥½å‹ç”³è¯·å’Œå…¥ç¾¤ç”³è¯·:

æ·»åŠ ç”³è¯·çš„æ—¶å€™å¯ä»¥`user.addApply(apply)`ï¼Œè·å–çš„æ—¶å€™å¯ä»¥è¿™æ ·è·å–ï¼š

```
const result = await ctx.model.Apply.findAndCountAll({
  where: {
    userId: ctx.session.user.id,
    hasHandled: false
  }
});
```

### å¤šå¯¹å¤š

user å’Œ group çš„å…³ç³»å°±æ˜¯å¤šå¯¹å¤šï¼Œå³ä¸€ä¸ªç”¨æˆ·å¯ä»¥å¯¹åº”å¤šä¸ªç¾¤ç»„ï¼Œä¸€ä¸ªç¾¤ç»„ä¹Ÿå¯ä»¥å¯¹åº”å¤šä¸ªç”¨æˆ·ï¼Œè¿™æ · sequelize ä¼šå»ºç«‹ä¸€ä¸ªä¸­é—´è¡¨ user_group æ¥å®ç°è¿™ç§å…³ç³»ã€‚

ä¸€èˆ¬æˆ‘è¿™ä¹ˆä½¿ç”¨ï¼š

```
group.addUser(user); // å»ºç«‹ç¾¤ç»„å’Œç”¨æˆ·çš„å…³ç³»
user.getGroups(); // è·å–ç”¨æˆ·çš„ç¾¤ç»„ä¿¡æ¯
```

### éœ€è¦æ³¨æ„çš„ç‚¹

1. sequelize çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸºäº promise çš„ï¼Œæ‰€æœ‰å¤§å¤šæ—¶å€™éƒ½ä½¿ç”¨ await è¿›è¡Œç­‰å¾…
2. ä¿®æ”¹äº†å¦ä¸ªæ¨¡å‹çš„å®ä¾‹çš„æŸä¸ªå±æ€§åï¼Œéœ€è¦ save
3. å½“æˆ‘ä»¬éœ€è¦æŠŠæ¨¡å‹çš„æ•°æ®è¿›è¡Œç»„åˆåè¿”å›ç»™å‰ç«¯çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ get({plain: true})è¿™ç§æ–¹å¼

## socketio

egg æä¾›äº† egg-socket.io æ’ä»¶ï¼Œéœ€è¦åœ¨å®‰è£… egg-socket.io ååœ¨ config/plugin.js å¼€å¯æ’ä»¶ï¼Œio æœ‰è‡ªå·±çš„ä¸­é—´ä»¶å’Œ controller

### socketio çš„è·¯ç”±

io çš„è·¯ç”±å’Œä¸€èˆ¬çš„ http è¯·æ±‚çš„ä¸å¤ªä¸€æ ·ï¼Œæ³¨æ„è¿™é‡Œçš„è·¯ç”±ä¸èƒ½æ·»åŠ ä¸­é—´ä»¶å¤„ç†ï¼ˆæˆ‘æ²¡æˆåŠŸï¼‰ï¼Œæ‰€ä»¥ç¦è¨€å¤„ç†æˆ‘æ˜¯åœ¨ controller é‡Œé¢å¤„ç†çš„

```
// åŠ å…¥ç¾¤
io.of('/').route('/v1/im/join', app.io.controller.im.join);
// å‘é€æ¶ˆæ¯
io.of('/').route('/v1/im/new-message', app.io.controller.im.newMessage);
// æŸ¥è¯¢æ¶ˆæ¯
io.of('/').route('/v1/im/get-messages', app.io.controller.im.getMessages);
```

### socketio çš„ä¸­é—´ä»¶

æœ‰ä¸¤ä¸ªé»˜è®¤çš„ä¸­é—´ä»¶ï¼Œä¸€ä¸ªæ˜¯è¿æ¥å’Œæ–­å¼€æ—¶å€™è°ƒç”¨çš„ connection Middlewareï¼Œè¿™é‡Œç”¨æ¥æ ¡éªŒç™»å½•çŠ¶æ€å’Œå¤„ç†ä¸šåŠ¡é€»è¾‘äº†ï¼›å¦å¤–ä¸€ä¸ªæ˜¯æ¯æ¬¡å‘æ¶ˆæ¯æ—¶å€™è°ƒç”¨çš„ packet Middlewareï¼Œè¿™é‡Œç”¨æ¥æ‰“å° log

ç”±äºé¢„è®¾äº†ç¦è¨€æƒé™ï¼Œåœ¨ controller é‡Œé¢è¿›è¡Œå¤„ç†

```
// å¯¹ç”¨æˆ·å‘è¨€çš„æƒé™è¿›è¡Œåˆ¤æ–­
if (!ctx.session.user.rights.some(right => right.keyName === 'speak')) {
  return;
}
```

### èŠå¤©

èŠå¤©åˆ†ä¸ºå•èŠå’Œç¾¤èŠï¼ŒèŠå¤©ä¿¡æ¯æš‚æ—¶æœ‰ä¸€èˆ¬çš„æ–‡å­—ã€å›¾ç‰‡ã€è§†é¢‘å’Œå®šä½æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡æ‰©å±•ä¸ºè®¢å•æˆ–è€…å•†å“ç­‰

### æ¶ˆæ¯

message çš„ç»“æ„è®¾è®¡å‚è€ƒäº†å‡ å®¶ç¬¬ä¸‰æ–¹æœåŠ¡çš„è®¾è®¡ï¼Œä¹Ÿç»“åˆæœ¬é¡¹ç›®è‡ªèº«çš„æƒ…å†µåšäº†è°ƒæ•´ï¼Œå¯ä»¥éšæ„æ‰©å±•ï¼Œåšå¦‚ä¸‹è¯´æ˜ï¼š

```
const Message = app.model.define('message', {
  /**
    * æ¶ˆæ¯ç±»å‹ï¼š
    * 0:å•èŠ
    * 1:ç¾¤èŠ
    */
  type: {
    type: STRING
  },
  // æ¶ˆæ¯ä½“
  body: {
    type: JSON
  },
  fromId: { type: INTEGER },
  toId: { type: INTEGER }
});
```

body é‡Œé¢å­˜æ”¾çš„æ˜¯æ¶ˆæ¯ä½“ï¼Œä½¿ç”¨ json ç”¨æ¥å­˜æ”¾ä¸åŒçš„æ¶ˆæ¯æ ¼å¼ï¼š

```
// æ–‡æœ¬æ¶ˆæ¯
{
  "type": "txt",
  "msg":"å“ˆå“ˆå“ˆ" //æ¶ˆæ¯å†…å®¹
}
```

```
// å›¾ç‰‡æ¶ˆæ¯
{
  "type": "img",
  "url": "http://nimtest.nos.netease.com/cbc500e8-e19c-4b0f-834b-c32d4dc1075e",
  "ext":"jpg",
  "w":360,    //å®½
  "h":480,    //é«˜
  "size": 388245
}
```

```
// è§†é¢‘æ¶ˆæ¯
{
  "type": 'video',
  "url": "http://nimtest.nos.netease.com/cbc500e8-e19c-4b0f-834b-c32d4dc1075e",
  "ext":"mp4",
  "w":360,    //å®½
  "h":480,    //é«˜
  "size": 388245
}
```

```
// åœ°ç†ä½ç½®æ¶ˆæ¯
{
  "type": "loc",
  "title":"ä¸­å›½ æµ™æ±Ÿçœ æ­å·å¸‚ ç½‘å•†è·¯ 599å·",    //åœ°ç†ä½ç½®title
  "lng":120.1908686708565,        // ç»åº¦
  "lat":30.18704515647036            // çº¬åº¦
}
```

### passport

è¿™ä¸ªç« èŠ‚çš„ egg å®˜æ–¹æ–‡æ¡£ï¼Œè¦ä½ çš„å‘½ï¼Œä¸€å®šè¦å»çœ‹æºç ï¼Œå¤ªå‘äººäº†ï¼Œæˆ‘ç ”ç©¶äº†ä¸€æ•´å¤©æ‰å¼„æ˜ç™½æ˜¯æ€ä¹ˆå›äº‹ã€‚å› ä¸ºæˆ‘æƒ³æ›´è‡ªç”±çš„æ§åˆ¶è´¦æˆ·å¯†ç ç™»å½•ï¼Œæ‰€ä»¥è´¦å·å¯†ç ç™»å½•å¹¶æ²¡æœ‰ä½¿ç”¨ passportï¼Œä½¿ç”¨çš„å°±æ˜¯æ™®ç”¨çš„ controller æ§åˆ¶çš„ã€‚

ä¸‹é¢è¯¦ç»†è¯´ä¸‹ä½¿ç”¨ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆæˆ‘é€‰ç”¨çš„æ˜¯ GitHubï¼‰ç™»å½•çš„è¿‡ç¨‹ï¼š

1. åœ¨[GitHub OAuth Apps](https://github.com/settings/applications/new)æ–°å»ºä½ çš„åº”ç”¨
1. åœ¨é¡¹ç›®å®‰è£… egg-passport å’Œ egg-passport-github
1. å¼€å¯æ’ä»¶ï¼š

```
// config/plugin.js
module.exports.passport = {
  enable: true,
  package: 'egg-passport',
};

module.exports.passportGithub = {
  enable: true,
  package: 'egg-passport-github',
};
```

3. é…ç½®ï¼š

```
// config/default.js
config.passportGithub = {
  key: 'your_clientID',
  secret: 'your_clientSecret',
  callbackURL: '/v1/passport/github/callback' // æ³¨æ„è¿™é‡Œéå¸¸çš„å…³é”®ï¼Œè¿™é‡Œéœ€è¦å’Œä½ åœ¨githubä¸Šé¢è®¾ç½®çš„Authorization callback URLä¸€è‡´ï¼Œæˆ‘å¼€å‘çš„æ—¶å€™æƒ³æ¢githubä¸Šé¢è®¾ç½®çš„Authorization callback URLä¸€ç›´æŠ¥é”™ï¼Œåæ¥å‘ç°éœ€è¦åœ¨è¿™é‡Œé…ç½®
};
```

4. éœ€è¦è®¾ç½®ä¸¤ä¸ª passport çš„ get è¯·æ±‚è·¯ç”±ï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬åœ¨ login é¡µé¢ç‚¹å‡»çš„è¯·æ±‚ï¼Œç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥è®¾ç½®çš„ callbackURLï¼Œè¿™é‡Œä¸»è¦æ˜¯ç¬¬ä¸‰æ–¹å¹³å°ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªå¯ç”¨çš„ codeï¼Œç„¶åæ ¹æ® OAuth2 æˆæƒè§„åˆ™å»è·å–ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯

```
const github = app.passport.authenticate('github', { successRedirect: '/v1/passport' }); // successRedirectå°±æ˜¯æœ€åæ ¡éªŒå®Œæ¯•åå‰ç«¯ä¼šè·³è½¬çš„è·¯ç”±
router.get('/v1/passport/github', github);
router.get('/v1/passport/github/callback', github);
```

5. è·å–åˆ°è¯¦ç»†ä¿¡æ¯åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ app.js é‡Œé¢çš„ app.passport.verify å»éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ä¸”å’Œæˆ‘ä»¬è‡ªèº«å¹³å°çš„ç”¨æˆ·ä¿¡æ¯åšå…³è”ï¼Œä¹Ÿè¦æˆæƒç»™ session

```
// åœ¨verifyå‡½æ•°æˆ‘ä»¬åªèƒ½è·å–ctxå’Œuser
module.exports = async (ctx, user) => {
  const { provider, id, name, photo } = user;
  if (provider === 'github') {
    // æŸ¥è¯¢authæ˜¯å¦å·²ç»æ³¨å†Œ
    const auth = await ctx.model.Authorization.findOne({
      where: {
        provider,
        uid: id
      }
    });
    if (!auth) {
      // å¦‚æœæ²¡æœ‰æ³¨å†Œçš„è¯å°±éœ€è¦ä½¿ç”¨æ‹¿åˆ°çš„userä¿¡æ¯æ³¨å†Œä¸‹
      const newAuth = await ctx.model.Authorization.create({
        provider,
        uid: id,
        username: name
      });
      const user = await ctx.model.User.create({
        nickname: name,
        photo
      });
      newAuth.setUser(user);
      // è¿™æ­¥å’Œä¸‹é¢çš„åŠŸèƒ½ä¸€æ ·ï¼Œæ·»åŠ authåˆ°session
      ctx.session.auth = newAuth;
    } else {
      ctx.session.auth = auth;
    }
  }
  return user;
};
```

## éƒ¨ç½²

æˆ‘æ˜¯åœ¨è…¾è®¯äº‘ä¹°çš„æœåŠ¡å™¨ centosï¼Œåœ¨é˜¿é‡Œäº‘ä¹°çš„åŸŸåï¼Œè£…äº† node(12.18.2) å’Œ nginxï¼Œä½¿ç”¨ nginx è¿›è¡Œåå‘ä»£ç†ã€‚ç”±äºæœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œæ²¡æœ‰ä½¿ç”¨ä¸€äº›è‡ªåŠ¨åŒ–å·¥å…· Jenkins å’Œ Docker
